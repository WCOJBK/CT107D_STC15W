C51 COMPILER V9.01   KEY                                                                   04/02/2017 12:20:51 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN key.OBJ
COMPILER INVOKED BY: E:\keil4-C51\C51\BIN\C51.EXE key.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <config.h>
   2          #include <key.h>
   3          #include <display.h>
   4          
   5          uchar keyPress = 0;
   6          bit key_re;
   7          uchar keyValue = 0;
   8          
   9          uchar KeyBuffer[5];
  10          uchar KeySub = 0;
  11          uchar KeyTimeCnt = 10;
  12          uchar KeyTemp = 0xff;
  13          
  14          uchar GetKey(){
  15   1              uchar date;
  16   1              if(KeySub == 0){
  17   2                      return 0xff;
  18   2              }else{
  19   2                      KeySub--;
  20   2                      date = KeyBuffer[KeySub];
  21   2                      return date; 
  22   2              }       
  23   1      }
  24          
  25          uchar TextKey(){
  26   1              if(KeySub == 0)
  27   1                      return 0;
  28   1              else
  29   1                      return 1;
  30   1      }
  31          
  32          
  33          uchar read_keyboard(void)
  34          {
  35   1          static unsigned char col;
  36   1          
  37   1              P3 = 0xf0; P42 = 1; P44 = 1;
  38   1      
  39   1          if((P3 != 0xf0)||(P42 != 0)||(P44 != 0)) //有按键按下
  40   1              keyPress++;
  41   1              else
  42   1                      keyPress = 0;  //抖动
  43   1          
  44   1          if(keyPress == 3)
  45   1          {
  46   2                      keyPress = 0;
  47   2                      key_re = 1;
  48   2                      
  49   2                      if(P44 == 0)                    col = 1;
  50   2                      if(P42 == 0)                    col = 2;
  51   2                      if((P3 & 0x20) == 0)    col = 3;
  52   2                      if((P3 & 0x10) == 0)    col = 4;
  53   2              
  54   2              P3 = 0x0F; P42 = 0; P44 = 0;
  55   2      
C51 COMPILER V9.01   KEY                                                                   04/02/2017 12:20:51 PAGE 2   

  56   2                      if((P3&0x01) == 0)      keyValue = (col-1);
  57   2                      if((P3&0x02) == 0)      keyValue = (col+3);
  58   2                      if((P3&0x04) == 0)      keyValue = (col+7);
  59   2                      if((P3&0x08) == 0)      keyValue = (col+11);
  60   2          }
  61   1          
  62   1              //连续三次检测到按键被按下，并且该按键已经释放
  63   1              P3 = 0x0f; P42 = 0; P44 = 0;
  64   1              
  65   1          if(((key_re == 1) && (P3 == 0x0f))&&(P42 == 0)&&(P44 == 0))
  66   1          {
  67   2              key_re = 0;
  68   2              return keyValue;
  69   2          }
  70   1          
  71   1          return 0xff;  //无按键按下或被按下的按键未被释放 
  72   1      }
  73          
  74          void KeyScan(){
  75   1              KeyTimeCnt--;
  76   1              if(KeyTimeCnt == 0){
  77   2                      KeyTimeCnt = 10;
  78   2                      KeyTemp = read_keyboard();
  79   2                      if(KeyTemp != 0xff){
  80   3                              KeyBuffer[KeySub] = KeyTemp;
  81   3                              KeySub++;                       
  82   3                      }
  83   2              }
  84   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    194    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
